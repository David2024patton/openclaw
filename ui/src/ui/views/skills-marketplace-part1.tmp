import { html, nothing } from "lit";
import type { SkillMessageMap } from "../controllers/skills";
import type { SkillStatusEntry, SkillStatusReport } from "../types";
import type { GatewayBrowserClient } from "../gateway";
import { renderHelpModal } from "../components/help-modal";

export type SkillsMarketplaceProps = {
  loading: boolean;
  report: SkillStatusReport | null;
  error: string | null;
  filter: string;
  categoryFilter: string;
  edits: Record<string, string>;
  busyKey: string | null;
  messages: SkillMessageMap;
  client: GatewayBrowserClient | null;
  selectedSkillKey: string | null;
  editingContent: string;
  onFilterChange: (next: string) => void;
  onCategoryFilterChange: (next: string) => void;
  onRefresh: () => void;
  onToggle: (skillKey: string, enabled: boolean) => Promise<void>;
  onEdit: (skillKey: string, value: string) => void;
  onSaveKey: (skillKey: string) => Promise<void>;
  onInstall: (skillKey: string, name: string, installId: string) => Promise<void>;
  onSelectSkill: (skillKey: string | null) => void;
  onLoadSkillContent: (skillKey: string) => Promise<void>;
  onSaveSkillContent: (skillKey: string, content: string) => Promise<void>;
  onDeleteSkill: (skillKey: string) => Promise<void>;
  onTestSkill: (skillKey: string) => Promise<void>;
  onCreateSkill: () => void;
};

// Define 10 skill categories
export const SKILL_CATEGORIES = [
  "Development",
  "Communication",
  "Media",
  "Files",
  "APIs",
  "AI & ML",
  "Database",
  "Security",
  "DevOps",
  "Other",
] as const;

export type SkillCategory = typeof SKILL_CATEGORIES[number];

// Help modal state
let helpModalOpen = false;

// Extract category from skill metadata or infer from name
function getSkillCategory(skill: SkillStatusEntry): SkillCategory {
  // Check if category is stored in metadata
  if (skill.metadata?.category && SKILL_CATEGORIES.includes(skill.metadata.category as SkillCategory)) {
    return skill.metadata.category as SkillCategory;
  }
  
  // Try to infer from name patterns
  const name = skill.name.toLowerCase();
  if (name.includes("code") || name.includes("lint") || name.includes("dev") || name.includes("programming")) return "Development";
  if (name.includes("chat") || name.includes("message") || name.includes("slack") || name.includes("discord") || name.includes("telegram") || name.includes("email")) return "Communication";
  if (name.includes("image") || name.includes("video") || name.includes("media") || name.includes("photo") || name.includes("audio")) return "Media";
  if (name.includes("file") || name.includes("doc") || name.includes("pdf") || name.includes("document")) return "Files";
  if (name.includes("api") || name.includes("http") || name.includes("web") || name.includes("rest") || name.includes("graphql")) return "APIs";
  if (name.includes("ai") || name.includes("model") || name.includes("llm") || name.includes("gpt") || name.includes("neural")) return "AI & ML";
  if (name.includes("database") || name.includes("db") || name.includes("sql") || name.includes("mongo") || name.includes("redis")) return "Database";
  if (name.includes("security") || name.includes("auth") || name.includes("encrypt") || name.includes("vulnerability") || name.includes("password")) return "Security";
  if (name.includes("deploy") || name.includes("docker") || name.includes("kubernetes") || name.includes("ci/cd") || name.includes("infrastructure")) return "DevOps";
  
  return "Other";
}

// Get all unique categories from skills
function getAllCategories(skills: SkillStatusEntry[]): string[] {
  const categories = new Set<string>();
  skills.forEach((skill) => categories.add(getSkillCategory(skill)));
  return Array.from(categories).sort();
}

export function renderSkillsMarketplace(props: SkillsMarketplaceProps) {
  const skills = props.report?.skills ?? [];
  const filter = props.filter.trim().toLowerCase();
  const categoryFilter = props.categoryFilter;
  
  // Filter skills
  let filtered = skills;
  if (filter) {
    filtered = filtered.filter((skill) =>
      [skill.name, skill.description, skill.source].join(" ").toLowerCase().includes(filter),
    );
  }
  if (categoryFilter && categoryFilter !== "all") {
    filtered = filtered.filter((skill) => getSkillCategory(skill) === categoryFilter);
  }
  
  const categories = getAllCategories(skills);
  const selectedSkill = props.selectedSkillKey
    ? skills.find((s) => {
        const skillKey = s.metadata?.skillKey || s.name;
        return skillKey === props.selectedSkillKey;
      })
    : null;

  return html`
    <div style="display: grid; grid-template-columns: ${props.selectedSkillKey ? "1fr 500px" : "1fr"}; gap: 1.5rem; height: calc(100vh - 200px);">
      <!-- Main Skills Grid -->
      <div>
        <section class="card">
          <div class="row" style="justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <div>
              <div class="card-title" style="display: flex; align-items: center; gap: 0.75rem;">
                <span>ðŸ›ï¸ Skills Marketplace</span>
                <button
                  class="btn btn-xs"
                  style="background: transparent; color: #9ca3af; padding: 0.25rem;"
                  title="What are skills?"
                  @click=${() => {
                    helpModalOpen = true;
                  }}
                >
                  â“
                </button>
              </div>
              <div class="card-sub">Browse, manage, and create skills to extend your agent's capabilities.</div>
            </div>
            <div style="display: flex; gap: 0.5rem;">
              <button
                class="btn"
                style="background: #a855f7; color: white; font-weight: 600;"
                @click=${props.onCreateSkill}
                title="Create a new skill"
              >
                âž• New Skill
              </button>
              <button class="btn" ?disabled=${props.loading} @click=${props.onRefresh}>
                ${props.loading ? "Loadingâ€¦" : "ðŸ”„ Refresh"}
              </button>
            </div>
          </div>

          <!-- Filters -->
          <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; margin-bottom: 1.5rem;">
            <label class="field" style="flex: 1;">
              <span>ðŸ” Search</span>
              <input
                .value=${props.filter}
                @input=${(e: Event) => props.onFilterChange((e.target as HTMLInputElement).value)}
                placeholder="Search skills by name, description, or source..."
              />
            </label>
            <label class="field" style="width: 220px;">
              <span>ðŸ“ Category</span>
              <select
                .value=${props.categoryFilter}
                @change=${(e: Event) => props.onCategoryFilterChange((e.target as HTMLSelectElement).value)}
              >
                <option value="all">All Categories</option>
                ${SKILL_CATEGORIES.map(
                  (cat) => html`<option value="${cat}">${cat}</option>`
                )}
              </select>
            </label>
          </div>

          ${props.error
            ? html`<div class="callout danger" style="margin-bottom: 1rem;">${props.error}</div>`
            : nothing}

          ${filtered.length === 0
            ? html`
                <div class="muted" style="text-align: center; padding: 3rem;">
                  <div style="font-size: 3rem; margin-bottom: 1rem;">ðŸ“¦</div>
                  <div style="font-size: 1.25rem; font-weight: 600; color: #d1d5db; margin-bottom: 0.5rem;">
                    No skills found
                  </div>
                  <div style="font-size: 0.875rem;">
                    ${filter || categoryFilter !== "all"
                      ? "Try adjusting your filters"
                      : "Click 'New Skill' to create your first skill"}
                  </div>
                </div>
              `
            : html`
                <div class="skills-grid" style="margin-top: 16px;">
                  <!-- Pinned Template Skill -->
                  ${html`
                    <div
                      style="
                        padding: 1rem;
                        background: linear-gradient(135deg, rgba(168, 85, 247, 0.15) 0%, rgba(59, 130, 246, 0.15) 100%);
                        border: 2px dashed #a855f7;
                        border-radius: var(--radius-lg);
                        cursor: pointer;
                        transition: all 0.2s ease;
                        position: relative;
                      "
